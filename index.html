<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Local 478 Ideas Pipeline</title>
  <meta name="description" content="IATSE Local 478 Ideas Pipeline - Collaborative idea tracking board">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="478 Ideas">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              750: '#293548',
              850: '#172033',
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    html {
      height: 100%;
      overflow: hidden;
    }
    body {
      height: 100%;
      overflow: hidden;
      background-color: #0f172a;
      color: #f1f5f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Prevent iOS rubber-banding on main scroll areas */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Animations */
    .modal-backdrop { animation: fadeIn 150ms ease-out; }
    .modal-content { animation: slideUp 200ms ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes successPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .success-pulse { animation: successPulse 300ms ease-out; }
    .blocked-glow { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.2); }

    /* Pull to refresh */
    .pull-indicator {
      transition: transform 0.2s ease-out;
    }
    .pulling .pull-indicator {
      transform: rotate(180deg);
    }

    /* Text utilities */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* Touch-friendly inputs */
    input, textarea, button, select {
      font-size: 16px; /* Prevents iOS zoom */
      touch-action: manipulation;
    }

    /* Active states for touch feedback */
    .touch-active:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    /* Modal full-screen on mobile */
    @media (max-width: 640px) {
      .modal-mobile-full {
        margin: 0 !important;
        border-radius: 0 !important;
        min-height: 100vh;
        max-height: 100vh;
      }
      .modal-mobile-full .modal-scroll {
        max-height: calc(100vh - 200px) !important;
      }
    }

    /* Safe area bottom padding for fixed elements */
    .safe-bottom {
      padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
    }
  </style>
</head>
<body>
  <!-- ==================== CONFIGURATION ==================== -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAivbTagLFR7FKyoaqMj0Gcjr4_ciAN79c",
      authDomain: "iatse-478-ideas-board.firebaseapp.com",
      projectId: "iatse-478-ideas-board",
      storageBucket: "iatse-478-ideas-board.firebasestorage.app",
      messagingSenderId: "547232221772",
      appId: "1:547232221772:web:34616e9c0e8fa126e302e9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const CONFIG = {
      ADMIN_CODE: '478'
    };

    const STAGES = [
      { id: 'new', label: 'New', emoji: 'üí°', color: '#3B82F6' },
      { id: 'research', label: 'Research', emoji: 'üîç', color: '#8B5CF6' },
      { id: 'poc', label: 'POC', emoji: 'üß™', color: '#F59E0B' },
      { id: 'codebase', label: 'Code', emoji: 'üíª', color: '#10B981' },
      { id: 'prototype', label: 'Prototype', emoji: 'üöÄ', color: '#06B6D4' },
      { id: 'testing', label: 'Testing', emoji: '‚úÖ', color: '#84CC16' },
      { id: 'deployed', label: 'Live', emoji: 'üéâ', color: '#22C55E' },
    ];
  </script>

  <!-- ==================== APP CONTAINER ==================== -->
  <div id="app">
    <!-- Loading State -->
    <div id="loading" class="flex-1 flex items-center justify-center">
      <div class="text-center">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-400">Loading ideas...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="flex-1 flex items-center justify-center p-4 hidden">
      <div class="text-center max-w-md">
        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-xl font-semibold text-white mb-2">Connection Error</h2>
        <p class="text-slate-400 mb-4">Unable to connect to the database.</p>
        <p id="error-message" class="text-sm text-red-400 bg-red-500/10 rounded-lg p-3 mb-4"></p>
        <button onclick="location.reload()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg touch-active">
          Try Again
        </button>
      </div>
    </div>

    <!-- Main App (hidden until loaded) -->
    <div id="main-app" class="flex-1 flex flex-col overflow-hidden hidden">
      <!-- Header -->
      <header class="flex-shrink-0 bg-slate-900 border-b border-slate-700 z-40">
        <div class="px-3 py-2 sm:px-4 sm:py-3">
          <div class="flex items-center justify-between gap-2">
            <!-- Logo -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <div class="w-9 h-9 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-white text-xs sm:text-sm">478</div>
              <div class="hidden xs:block sm:block">
                <h1 class="text-sm sm:text-lg font-semibold text-white leading-tight">Local 478</h1>
                <p class="text-[10px] sm:text-xs text-slate-400 leading-tight">Ideas Pipeline</p>
              </div>
            </div>

            <!-- View Toggle -->
            <div class="flex items-center bg-slate-800 rounded-lg p-0.5 sm:p-1">
              <button onclick="setView('pipeline')" id="btn-pipeline" class="px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors bg-blue-600 text-white touch-active">Pipeline</button>
              <button onclick="setView('category')" id="btn-category" class="px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors text-slate-400 touch-active">Categories</button>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
              <button onclick="refreshData()" id="refresh-btn" class="p-2.5 sm:p-2 text-slate-400 hover:text-white transition-colors rounded-lg touch-active" title="Refresh">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              </button>
              <button onclick="openSubmitModal()" class="px-2.5 py-2 sm:px-3 sm:py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors touch-active">
                <span class="sm:hidden">+</span>
                <span class="hidden sm:inline">+ Submit</span>
              </button>
              <button onclick="toggleAdmin()" id="btn-admin" class="px-2.5 py-2 sm:px-3 sm:py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs sm:text-sm font-medium rounded-lg transition-colors touch-active">
                <span class="sm:hidden">‚öôÔ∏è</span>
                <span class="hidden sm:inline">Admin</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Offline Banner -->
      <div id="offline-banner" class="hidden bg-amber-600 text-white text-center py-2 px-4 text-sm font-medium flex-shrink-0">
        <span>üì¥ You're offline. Changes will sync when connected.</span>
      </div>

      <!-- Main Content -->
      <main id="content" class="flex-1 flex flex-col overflow-hidden"></main>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->

  <!-- Submit Modal -->
  <div id="submit-modal" class="fixed inset-0 bg-black/70 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeSubmitModal()">
    <div class="bg-slate-800 rounded-t-2xl sm:rounded-xl w-full sm:max-w-lg sm:m-4 modal-content modal-mobile-full" onclick="event.stopPropagation()">
      <div id="submit-success" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-xl font-semibold text-white">Idea Submitted!</h2>
        <p class="text-slate-400 mt-2">Thanks for your contribution</p>
      </div>
      <div id="submit-form-container">
        <!-- Drag handle for mobile -->
        <div class="sm:hidden flex justify-center pt-3 pb-1">
          <div class="w-10 h-1 bg-slate-600 rounded-full"></div>
        </div>
        <div class="p-4 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-white mb-4">Submit New Idea</h2>
          <form id="submit-form" onsubmit="submitIdea(event)">
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-300 mb-2">Your Name <span class="text-red-400">*</span></label>
              <input type="text" id="input-submitter" required placeholder="Enter your name" autocomplete="name" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-300 mb-2">Idea Title <span class="text-red-400">*</span></label>
              <input type="text" id="input-title" required placeholder="What's your idea?" autocomplete="off" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-300 mb-2">Description (optional)</label>
              <textarea id="input-description" rows="3" placeholder="Describe your idea..." class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-medium text-slate-300 mb-2">Categories</label>
              <div id="category-select" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex gap-3 safe-bottom">
              <button type="button" onclick="closeSubmitModal()" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-colors touch-active font-medium">Cancel</button>
              <button type="submit" id="submit-btn" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors touch-active font-medium">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Prompt Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/70 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeAdminModal()">
    <div class="bg-slate-800 rounded-t-2xl sm:rounded-xl w-full sm:max-w-sm sm:m-4 modal-content" onclick="event.stopPropagation()">
      <!-- Drag handle for mobile -->
      <div class="sm:hidden flex justify-center pt-3 pb-1">
        <div class="w-10 h-1 bg-slate-600 rounded-full"></div>
      </div>
      <div class="p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold text-white mb-4">Admin Access</h2>
        <form onsubmit="loginAdmin(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Enter admin code</label>
            <input type="password" id="admin-code-input" inputmode="numeric" placeholder="Enter code..." class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-xl tracking-widest">
            <p id="admin-error" class="mt-2 text-sm text-red-400 hidden">Invalid admin code</p>
          </div>
          <div class="flex gap-3 safe-bottom">
            <button type="button" onclick="closeAdminModal()" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-colors touch-active font-medium">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors touch-active font-medium">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Idea Detail Modal -->
  <div id="idea-modal" class="fixed inset-0 bg-black/70 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeIdeaModal()">
    <div class="bg-slate-800 rounded-t-2xl sm:rounded-xl w-full sm:max-w-2xl sm:m-4 modal-content modal-mobile-full max-h-[95vh] sm:max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
      <div id="idea-modal-content" class="flex-1 overflow-hidden flex flex-col"></div>
    </div>
  </div>

  <!-- ==================== APPLICATION LOGIC ==================== -->
  <script>
    // State
    let state = {
      ideas: [],
      categories: [],
      view: 'pipeline',
      activeStage: 'new',
      isAdmin: localStorage.getItem('local478_admin') === 'true',
      selectedIdea: null,
      selectedCategories: [],
      selectedCategoryView: null,
      isRefreshing: false,
      isOffline: !navigator.onLine,
      isEditingIdea: false
    };

    // ==================== FIREBASE FUNCTIONS ====================
    const ideasRef = db.collection('ideas');
    const categoriesRef = db.collection('categories');

    // Real-time listener for ideas
    function subscribeToIdeas() {
      return ideasRef.onSnapshot(snapshot => {
        state.ideas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
        // Update selected idea if it's open
        if (state.selectedIdea) {
          state.selectedIdea = state.ideas.find(i => i.id === state.selectedIdea.id);
          if (state.selectedIdea) renderIdeaModal();
        }
      }, err => {
        console.error('Ideas listener error:', err);
        showToast('Connection error. Retrying...');
      });
    }

    // Real-time listener for categories
    function subscribeToCategories() {
      return categoriesRef.onSnapshot(snapshot => {
        state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      }, err => {
        console.error('Categories listener error:', err);
      });
    }

    // Save a single idea
    async function saveIdea(idea) {
      const { id, ...data } = idea;
      data.updatedAt = Date.now();
      if (id) {
        await ideasRef.doc(id).set(data, { merge: true });
      } else {
        const docRef = await ideasRef.add(data);
        return docRef.id;
      }
    }

    // Delete an idea
    async function deleteIdeaFromDb(ideaId) {
      await ideasRef.doc(ideaId).delete();
    }

    // Save a single category
    async function saveCategory(category) {
      const { id, ...data } = category;
      if (id) {
        await categoriesRef.doc(id).set(data, { merge: true });
      } else {
        const docRef = await categoriesRef.add(data);
        return docRef.id;
      }
    }

    // Initialize default categories if none exist
    async function initializeCategories() {
      const snapshot = await categoriesRef.get();
      if (snapshot.empty) {
        const defaultCategories = [
          { label: 'Workflow', color: '#3B82F6' },
          { label: 'Safety', color: '#EF4444' },
          { label: 'Training', color: '#8B5CF6' },
          { label: 'Equipment', color: '#F59E0B' },
          { label: 'Communication', color: '#10B981' },
          { label: 'Benefits', color: '#EC4899' }
        ];
        for (const cat of defaultCategories) {
          await categoriesRef.add(cat);
        }
      }
    }

    function refreshData() {
      // With real-time sync, just show a visual feedback
      const btn = document.getElementById('refresh-btn');
      btn.classList.add('animate-spin');
      setTimeout(() => btn.classList.remove('animate-spin'), 500);
      showToast('Data is live-synced!');
    }

    // Simple toast notification
    function showToast(message) {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-700 text-white px-4 py-2 rounded-full text-sm z-50 shadow-lg';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      try {
        // Initialize default categories if needed
        await initializeCategories();

        // Subscribe to real-time updates
        subscribeToIdeas();
        subscribeToCategories();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        updateAdminButton();
        render();
      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    // ==================== VIEW MANAGEMENT ====================
    function setView(view) {
      state.view = view;
      state.selectedCategoryView = null;
      document.getElementById('btn-pipeline').className = view === 'pipeline'
        ? 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors bg-blue-600 text-white touch-active'
        : 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors text-slate-400 touch-active';
      document.getElementById('btn-category').className = view === 'category'
        ? 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors bg-blue-600 text-white touch-active'
        : 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium transition-colors text-slate-400 touch-active';
      render();
    }

    function setActiveStage(stageId) {
      state.activeStage = stageId;
      render();
      // Scroll active tab into view
      setTimeout(() => {
        const activeTab = document.querySelector(`[data-stage="${stageId}"]`);
        if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }, 10);
    }

    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const content = document.getElementById('content');
      if (state.view === 'pipeline') {
        content.innerHTML = renderPipelineView();
      } else {
        content.innerHTML = state.selectedCategoryView ? renderCategoryDetail() : renderCategoryView();
      }
    }

    function renderPipelineView() {
      const stageIdeas = state.ideas.filter(i => i.stage === state.activeStage);
      const activeIndex = STAGES.findIndex(s => s.id === state.activeStage);
      const activeStage = STAGES[activeIndex];
      const blockedCount = stageIdeas.filter(i => i.blocked).length;

      return `
        <div class="flex-shrink-0 bg-slate-900 border-b border-slate-700">
          <div class="px-2 sm:px-4">
            <div class="flex items-center justify-center gap-2 sm:gap-4 py-2 sm:py-3">
              ${STAGES.map(stage => {
                const count = state.ideas.filter(i => i.stage === stage.id).length;
                const blocked = state.ideas.filter(i => i.stage === stage.id && i.blocked).length;
                const isActive = state.activeStage === stage.id;
                return `
                  <button data-stage="${stage.id}" onclick="setActiveStage('${stage.id}')" class="stage-tab flex flex-col items-center justify-center px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg whitespace-nowrap transition-all touch-active min-w-[44px] min-h-[44px] ${isActive ? 'text-white' : 'text-slate-400'}" style="${isActive ? `background-color: ${stage.color}30; color: ${stage.color}` : ''}">
                    <span class="text-lg sm:text-xl">${stage.emoji}</span>
                    <span class="text-[10px] sm:text-xs mt-0.5 ${isActive ? 'font-semibold' : 'font-normal text-slate-500'}">${count}${blocked > 0 ? 'üö©' : ''}</span>
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>

        <!-- Current Stage Header -->
        <div class="flex-shrink-0 px-3 sm:px-4 py-3 bg-slate-850 border-b border-slate-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center text-2xl" style="background-color: ${activeStage.color}20">
                ${activeStage.emoji}
              </div>
              <div>
                <h2 class="text-lg font-semibold text-white">${activeStage.label}</h2>
                <p class="text-xs text-slate-400">${stageIdeas.length} idea${stageIdeas.length !== 1 ? 's' : ''}${blockedCount > 0 ? ` ¬∑ ${blockedCount} blocked` : ''}</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button onclick="navigateStage(-1)" ${activeIndex === 0 ? 'disabled' : ''} class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors touch-active">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              </button>
              <button onclick="navigateStage(1)" ${activeIndex === STAGES.length - 1 ? 'disabled' : ''} class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors touch-active">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Ideas Content -->
        <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4" id="ideas-scroll">
          <div class="max-w-7xl mx-auto pb-4">
            ${stageIdeas.length === 0 ? `
              <div class="text-center py-16">
                <div class="text-5xl mb-4">${STAGES[activeIndex].emoji}</div>
                <p class="text-slate-400 text-lg">No ideas in this stage</p>
                <p class="text-slate-500 text-sm mt-2">${state.activeStage === 'new' ? 'Tap + to submit a new idea!' : 'Move ideas from previous stages'}</p>
              </div>
            ` : `
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                ${stageIdeas.sort((a, b) => {
                  if (a.blocked !== b.blocked) return b.blocked - a.blocked;
                  return (b.createdAt || 0) - (a.createdAt || 0);
                }).map(idea => renderIdeaCard(idea)).join('')}
              </div>
            `}
          </div>
        </div>

      `;
    }

    function renderCategoryView() {
      return `
        <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4">
          <div class="max-w-7xl mx-auto pb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
              ${state.categories.map(cat => {
                const catIdeas = state.ideas.filter(i => (i.categories || []).includes(cat.id));
                const blocked = catIdeas.filter(i => i.blocked).length;
                const stageBreakdown = STAGES.map(s => ({ ...s, count: catIdeas.filter(i => i.stage === s.id).length }));
                const maxCount = Math.max(...stageBreakdown.map(s => s.count), 1);
                return `
                  <div onclick="openCategoryDetail('${cat.id}')" class="bg-slate-800 rounded-xl p-4 sm:p-5 cursor-pointer active:bg-slate-750 transition-all border-2 border-transparent active:border-slate-600 touch-active">
                    <div class="flex items-start justify-between mb-4">
                      <h3 class="text-base sm:text-lg font-semibold" style="color: ${cat.color}">${cat.label}</h3>
                      <div class="flex items-center gap-2">
                        ${blocked > 0 ? `<span class="text-red-400 text-sm">üö©${blocked}</span>` : ''}
                        <span class="px-2 py-1 bg-slate-700 rounded-lg text-sm text-slate-300">${catIdeas.length}</span>
                      </div>
                    </div>
                    <div class="space-y-1.5">
                      ${stageBreakdown.map(stage => `
                        <div class="flex items-center gap-2">
                          <span class="text-xs w-5">${stage.emoji}</span>
                          <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: ${(stage.count / maxCount) * 100}%; background-color: ${stage.color}; min-width: ${stage.count > 0 ? '8px' : '0'}"></div>
                          </div>
                          <span class="text-xs text-slate-500 w-4 text-right">${stage.count}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
              ${state.isAdmin ? `
                <div onclick="openAddCategoryModal()" class="bg-slate-800/50 rounded-xl p-5 cursor-pointer active:bg-slate-800 transition-all border-2 border-dashed border-slate-600 active:border-slate-500 flex items-center justify-center min-h-[180px] touch-active">
                  <div class="text-center">
                    <div class="text-4xl mb-2">+</div>
                    <p class="text-slate-400">Add Category</p>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderCategoryDetail() {
      const category = state.categories.find(c => c.id === state.selectedCategoryView);
      if (!category) return '';
      const categoryIdeas = state.ideas.filter(i => (i.categories || []).includes(category.id));

      return `
        <div class="flex flex-col h-full overflow-hidden">
          <div class="flex-shrink-0 bg-slate-900 border-b border-slate-700">
            <div class="px-3 sm:px-4 py-3 sm:py-4">
              <button onclick="state.selectedCategoryView = null; render()" class="flex items-center gap-2 text-slate-400 active:text-white mb-3 transition-colors touch-active min-h-[44px]">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back
              </button>
              <div class="flex items-center gap-3 flex-wrap">
                <span class="px-4 py-2 rounded-lg text-base sm:text-lg font-medium" style="background-color: ${category.color}30; color: ${category.color}">${category.label}</span>
                <span class="text-slate-400">${categoryIdeas.length} idea${categoryIdeas.length !== 1 ? 's' : ''}</span>
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4">
            <div class="max-w-7xl mx-auto pb-4">
              ${categoryIdeas.length === 0 ? `
                <div class="text-center py-16"><p class="text-slate-400">No ideas in this category</p></div>
              ` : `
                <div class="space-y-3">
                  ${categoryIdeas.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).map(idea => {
                    const stage = STAGES.find(s => s.id === idea.stage);
                    return `
                      <div onclick="openIdeaModal('${idea.id}')" class="bg-slate-800 rounded-xl p-4 cursor-pointer active:bg-slate-750 transition-all flex items-center gap-4 touch-active min-h-[72px]">
                        <div class="w-1.5 h-12 rounded-full flex-shrink-0" style="background-color: ${stage?.color}"></div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-medium text-white truncate">${escapeHtml(idea.title)}</h3>
                            ${idea.blocked ? '<span class="text-red-400 flex-shrink-0">üö©</span>' : ''}
                          </div>
                          <div class="flex items-center gap-2 sm:gap-3 text-sm flex-wrap">
                            <span class="px-2 py-0.5 rounded text-xs" style="background-color: ${stage?.color}20; color: ${stage?.color}">${stage?.emoji} ${stage?.label}</span>
                            <span class="text-slate-500 text-xs">by ${escapeHtml(idea.submitter)}</span>
                          </div>
                        </div>
                        <svg class="w-5 h-5 text-slate-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderIdeaCard(idea) {
      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const displayCategories = ideaCategories.slice(0, 2);
      const remainingCount = ideaCategories.length - 2;
      const noteCount = (idea.notes || []).length;

      return `
        <div onclick="openIdeaModal('${idea.id}')" class="bg-slate-800 rounded-xl p-4 cursor-pointer active:bg-slate-750 transition-all border-l-4 touch-active min-h-[100px] ${idea.blocked ? 'blocked-glow' : ''}" style="border-left-color: ${stage.color}">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="font-medium text-white line-clamp-2 text-sm sm:text-base">${escapeHtml(idea.title)}</h3>
            <div class="flex items-center gap-1 flex-shrink-0">
              ${idea.blocked ? '<span class="text-red-400">üö©</span>' : ''}
              ${noteCount > 0 ? `<span class="text-slate-400 text-xs">üìù${noteCount}</span>` : ''}
            </div>
          </div>
          ${idea.description ? `<p class="text-slate-400 text-xs sm:text-sm line-clamp-2 mb-3">${escapeHtml(idea.description)}</p>` : ''}
          ${ideaCategories.length > 0 ? `
            <div class="flex flex-wrap gap-1.5 mb-3">
              ${displayCategories.map(cat => `<span class="px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.label}</span>`).join('')}
              ${remainingCount > 0 ? `<span class="px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-medium bg-slate-700 text-slate-400">+${remainingCount}</span>` : ''}
            </div>
          ` : ''}
          <div class="flex items-center justify-between text-[10px] sm:text-xs text-slate-500">
            <span>by ${escapeHtml(idea.submitter)}</span>
            ${idea.createdAt ? `<span>${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
      `;
    }

    // ==================== MODAL FUNCTIONS ====================
    function openSubmitModal() {
      state.selectedCategories = [];
      document.getElementById('submit-form').reset();
      document.getElementById('submit-success').classList.add('hidden');
      document.getElementById('submit-form-container').classList.remove('hidden');
      renderCategorySelect();
      document.getElementById('submit-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeSubmitModal() {
      document.getElementById('submit-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function renderCategorySelect() {
      const container = document.getElementById('category-select');
      container.innerHTML = state.categories.map(cat => `
        <button type="button" onclick="toggleCategorySelect('${cat.id}')" class="px-3 py-2 rounded-full text-sm font-medium transition-all touch-active min-h-[40px] ${state.selectedCategories.includes(cat.id) ? 'ring-2 ring-offset-2 ring-offset-slate-800' : 'opacity-60'}" style="background-color: ${cat.color}30; color: ${cat.color};">${cat.label}</button>
      `).join('');
    }

    function toggleCategorySelect(catId) {
      if (state.selectedCategories.includes(catId)) {
        state.selectedCategories = state.selectedCategories.filter(id => id !== catId);
      } else {
        state.selectedCategories.push(catId);
      }
      renderCategorySelect();
    }

    async function submitIdea(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      const submitter = document.getElementById('input-submitter').value.trim();
      const title = document.getElementById('input-title').value.trim();
      const description = document.getElementById('input-description').value.trim();

      if (!submitter || !title) {
        btn.disabled = false;
        btn.textContent = 'Submit';
        return;
      }

      const newIdea = {
        title,
        description,
        submitter,
        stage: 'new',
        categories: [...state.selectedCategories],
        blocked: false,
        blockedReason: '',
        notes: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      try {
        await ideasRef.add(newIdea);
        document.getElementById('submit-form-container').classList.add('hidden');
        document.getElementById('submit-success').classList.remove('hidden');
        setTimeout(() => {
          closeSubmitModal();
        }, 1500);
      } catch (err) {
        showToast('Failed to submit. Try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit';
      }
    }

    function openIdeaModal(ideaId) {
      state.selectedIdea = state.ideas.find(i => i.id === ideaId);
      if (!state.selectedIdea) return;
      renderIdeaModal();
      document.getElementById('idea-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeIdeaModal() {
      document.getElementById('idea-modal').classList.add('hidden');
      document.body.style.overflow = '';
      state.selectedIdea = null;
      state.isEditingIdea = false;
    }

    function renderIdeaModal() {
      const idea = state.selectedIdea;
      if (!idea) return;

      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const availableCategories = state.categories.filter(c => !(idea.categories || []).includes(c.id));

      document.getElementById('idea-modal-content').innerHTML = `
        <!-- Drag handle for mobile -->
        <div class="sm:hidden flex justify-center pt-3 pb-1 flex-shrink-0">
          <div class="w-10 h-1 bg-slate-600 rounded-full"></div>
        </div>

        <!-- Header -->
        <div class="p-4 sm:p-6 border-b border-slate-700 flex-shrink-0">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              ${state.isEditingIdea ? `
                <input type="text" id="edit-title" value="${escapeHtml(idea.title)}" class="w-full text-lg sm:text-xl font-semibold text-white mb-2 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              ` : `
                <h2 class="text-lg sm:text-xl font-semibold text-white mb-2 pr-2">${escapeHtml(idea.title)}</h2>
              `}
              <div class="flex items-center gap-2 flex-wrap">
                <span class="px-3 py-1 rounded-full text-xs sm:text-sm font-medium" style="background-color: ${stage.color}20; color: ${stage.color}">${stage.emoji} ${stage.label}</span>
                ${idea.blocked ? '<span class="px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-red-500/20 text-red-400">üö© Blocked</span>' : ''}
              </div>
            </div>
            <div class="flex items-center gap-1">
              ${state.isAdmin && !state.isEditingIdea ? `
                <button onclick="startEditIdea()" class="text-slate-400 active:text-blue-400 p-2 touch-active rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center" title="Edit">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
              ` : ''}
              <button onclick="closeIdeaModal()" class="text-slate-400 active:text-white p-2 touch-active rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto scroll-container p-4 sm:p-6 space-y-5 modal-scroll">
          ${state.isEditingIdea ? `
            <div>
              <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Description</h3>
              <textarea id="edit-description" rows="4" class="w-full text-slate-200 text-sm sm:text-base bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">${escapeHtml(idea.description || '')}</textarea>
            </div>
            <div class="flex gap-2">
              <button onclick="saveEditIdea('${idea.id}')" class="flex-1 px-4 py-3 bg-blue-600 active:bg-blue-700 text-white text-sm font-medium rounded-xl transition-colors touch-active">Save Changes</button>
              <button onclick="cancelEditIdea()" class="px-4 py-3 bg-slate-700 active:bg-slate-600 text-white text-sm font-medium rounded-xl transition-colors touch-active">Cancel</button>
            </div>
          ` : idea.description ? `
            <div>
              <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Description</h3>
              <p class="text-slate-200 text-sm sm:text-base whitespace-pre-wrap">${escapeHtml(idea.description)}</p>
            </div>
          ` : ''}

          ${idea.blocked && idea.blockedReason ? `
            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
              <h3 class="text-xs sm:text-sm font-medium text-red-400 mb-1">Blocked Reason</h3>
              <p class="text-red-300 text-sm">${escapeHtml(idea.blockedReason)}</p>
            </div>
          ` : ''}

          <div>
            <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Categories</h3>
            <div class="flex flex-wrap gap-2">
              ${ideaCategories.length > 0 ? ideaCategories.map(cat => `
                <span class="px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium inline-flex items-center gap-2" style="background-color: ${cat.color}20; color: ${cat.color}">
                  ${cat.label}
                  ${state.isAdmin ? `<button onclick="removeIdeaCategory('${idea.id}', '${cat.id}')" class="hover:opacity-70 min-w-[20px] min-h-[20px]">√ó</button>` : ''}
                </span>
              `).join('') : '<span class="text-slate-500 text-sm">No categories</span>'}
            </div>
            ${state.isAdmin && availableCategories.length > 0 ? `
              <div class="mt-3">
                <p class="text-xs text-slate-500 mb-2">Add category:</p>
                <div class="flex flex-wrap gap-2">
                  ${availableCategories.map(cat => `
                    <button onclick="addIdeaCategory('${idea.id}', '${cat.id}')" class="px-2 py-1.5 rounded-full text-xs font-medium opacity-50 active:opacity-100 transition-opacity touch-active min-h-[32px]" style="background-color: ${cat.color}20; color: ${cat.color}">+ ${cat.label}</button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <div class="flex items-center gap-4 sm:gap-6 text-xs sm:text-sm text-slate-400 flex-wrap">
            <span>by <span class="text-white">${escapeHtml(idea.submitter)}</span></span>
            ${idea.createdAt ? `<span>${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
          </div>

          <div>
            <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-3">Notes (${(idea.notes || []).length})</h3>
            <div class="space-y-3">
              ${(idea.notes || []).map(note => `
                <div class="bg-slate-700/50 rounded-xl p-3">
                  <div class="flex items-start justify-between gap-2">
                    <p class="text-slate-200 text-sm">${escapeHtml(note.text)}</p>
                    ${state.isAdmin ? `<button onclick="deleteNote('${idea.id}', '${note.id}')" class="text-slate-500 active:text-red-400 text-xs flex-shrink-0 touch-active min-w-[44px] min-h-[32px]">Delete</button>` : ''}
                  </div>
                  <div class="flex items-center gap-3 mt-2 text-xs text-slate-500">
                    <span>${escapeHtml(note.author)}</span>
                    <span>${new Date(note.date).toLocaleDateString()}</span>
                  </div>
                </div>
              `).join('')}
            </div>
            ${state.isAdmin ? `
              <div class="mt-4 space-y-2">
                <input type="text" id="note-author" placeholder="Your name" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-2">
                  <input type="text" id="note-text" placeholder="Add a note..." class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onkeydown="if(event.key==='Enter')addNote('${idea.id}')">
                  <button onclick="addNote('${idea.id}')" class="px-4 py-3 bg-blue-600 active:bg-blue-700 text-white text-sm rounded-xl transition-colors touch-active min-w-[60px]">Add</button>
                </div>
              </div>
            ` : ''}
          </div>

          ${state.isAdmin ? `
            <div class="border-t border-slate-700 pt-5 space-y-4">
              <div>
                <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Move to Stage</h3>
                <div class="flex flex-wrap gap-2">
                  ${STAGES.map(s => `
                    <button onclick="moveIdea('${idea.id}', '${s.id}')" ${s.id === idea.stage ? 'disabled' : ''} class="px-3 py-2 rounded-xl text-xs sm:text-sm font-medium transition-colors touch-active min-h-[40px] ${s.id === idea.stage ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'active:opacity-80'}" style="${s.id !== idea.stage ? `background-color: ${s.color}30; color: ${s.color}` : ''}">${s.emoji} ${s.label}</button>
                  `).join('')}
                </div>
              </div>

              <div>
                <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Status</h3>
                <div id="blocked-controls">
                  ${idea.blocked ? `
                    <button onclick="unblockIdea('${idea.id}')" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-green-600/20 active:bg-green-600/30 text-green-400 touch-active min-h-[48px]">‚úì Unblock Idea</button>
                  ` : `
                    <div id="block-form-${idea.id}" class="hidden flex gap-2 flex-col sm:flex-row">
                      <input type="text" id="block-reason-${idea.id}" placeholder="Reason for blocking..." class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                      <div class="flex gap-2">
                        <button onclick="confirmBlockIdea('${idea.id}')" class="flex-1 sm:flex-none px-4 py-3 bg-red-600 active:bg-red-700 text-white text-sm rounded-xl transition-colors touch-active">Block</button>
                        <button onclick="cancelBlockIdea('${idea.id}')" class="flex-1 sm:flex-none px-4 py-3 bg-slate-700 active:bg-slate-600 text-white text-sm rounded-xl transition-colors touch-active">Cancel</button>
                      </div>
                    </div>
                    <button id="block-btn-${idea.id}" onclick="showBlockForm('${idea.id}')" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-red-600/20 active:bg-red-600/30 text-red-400 touch-active min-h-[48px]">üö© Flag as Blocked</button>
                  `}
                </div>
              </div>

              <div class="safe-bottom">
                <button onclick="deleteIdea('${idea.id}')" id="delete-btn-${idea.id}" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-slate-700 active:bg-slate-600 text-red-400 touch-active min-h-[48px]">Delete Idea</button>
              </div>
            </div>
          ` : '<div class="safe-bottom"></div>'}
        </div>
      `;
    }

    function openAdminModal() {
      document.getElementById('admin-code-input').value = '';
      document.getElementById('admin-error').classList.add('hidden');
      document.getElementById('admin-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => document.getElementById('admin-code-input').focus(), 100);
    }

    function closeAdminModal() {
      document.getElementById('admin-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function toggleAdmin() {
      if (state.isAdmin) {
        state.isAdmin = false;
        localStorage.removeItem('local478_admin');
        updateAdminButton();
        render();
        showToast('Admin mode disabled');
      } else {
        openAdminModal();
      }
    }

    function loginAdmin(e) {
      e.preventDefault();
      const code = document.getElementById('admin-code-input').value;
      if (code === CONFIG.ADMIN_CODE) {
        state.isAdmin = true;
        localStorage.setItem('local478_admin', 'true');
        closeAdminModal();
        updateAdminButton();
        render();
        showToast('Admin mode enabled');
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
        document.getElementById('admin-code-input').value = '';
      }
    }

    function updateAdminButton() {
      const btn = document.getElementById('btn-admin');
      if (state.isAdmin) {
        btn.innerHTML = '<span class="sm:hidden">üîì</span><span class="hidden sm:inline">Exit Admin</span>';
        btn.className = 'px-2.5 py-2 sm:px-3 sm:py-2 bg-red-600/20 active:bg-red-600/30 text-red-400 text-xs sm:text-sm font-medium rounded-lg transition-colors border border-red-600/30 touch-active';
      } else {
        btn.innerHTML = '<span class="sm:hidden">‚öôÔ∏è</span><span class="hidden sm:inline">Admin</span>';
        btn.className = 'px-2.5 py-2 sm:px-3 sm:py-2 bg-slate-700 active:bg-slate-600 text-slate-300 text-xs sm:text-sm font-medium rounded-lg transition-colors touch-active';
      }
    }

    function openCategoryDetail(catId) {
      state.selectedCategoryView = catId;
      render();
    }

    function openAddCategoryModal() {
      const label = prompt('Enter category label (e.g., "üìä Analytics"):');
      if (!label || !label.trim()) return;
      const colors = ['#EC4899', '#8B5CF6', '#10B981', '#F59E0B', '#6366F1', '#06B6D4', '#EF4444'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      addCategory(label.trim(), color);
    }

    // ==================== DATA OPERATIONS ====================
    async function moveIdea(ideaId, newStage) {
      try {
        await ideasRef.doc(ideaId).update({
          stage: newStage,
          updatedAt: Date.now()
        });
        showToast('Idea moved');
      } catch (err) {
        showToast('Failed to move. Try again.');
      }
    }

    function showBlockForm(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.add('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-reason-${ideaId}`).focus();
    }

    function cancelBlockIdea(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.add('hidden');
    }

    async function confirmBlockIdea(ideaId) {
      const reason = document.getElementById(`block-reason-${ideaId}`).value.trim();
      try {
        await ideasRef.doc(ideaId).update({
          blocked: true,
          blockedReason: reason,
          updatedAt: Date.now()
        });
        showToast('Idea blocked');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function unblockIdea(ideaId) {
      try {
        await ideasRef.doc(ideaId).update({
          blocked: false,
          blockedReason: '',
          updatedAt: Date.now()
        });
        showToast('Idea unblocked');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addNote(ideaId) {
      const author = document.getElementById('note-author').value.trim();
      const text = document.getElementById('note-text').value.trim();
      if (!author || !text) {
        showToast('Enter name and note');
        return;
      }

      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const note = { id: generateId(), text, author, date: Date.now() };
      const notes = [...(idea.notes || []), note];

      try {
        await ideasRef.doc(ideaId).update({
          notes: notes,
          updatedAt: Date.now()
        });
        document.getElementById('note-author').value = '';
        document.getElementById('note-text').value = '';
        showToast('Note added');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function deleteNote(ideaId, noteId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const notes = (idea.notes || []).filter(n => n.id !== noteId);

      try {
        await ideasRef.doc(ideaId).update({
          notes: notes,
          updatedAt: Date.now()
        });
        showToast('Note deleted');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const categories = [...(idea.categories || []), catId];
      try {
        await ideasRef.doc(ideaId).update({
          categories: categories,
          updatedAt: Date.now()
        });
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function removeIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const categories = (idea.categories || []).filter(c => c !== catId);
      try {
        await ideasRef.doc(ideaId).update({
          categories: categories,
          updatedAt: Date.now()
        });
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function deleteIdea(ideaId) {
      const btn = document.getElementById(`delete-btn-${ideaId}`);
      if (btn.dataset.confirm !== 'true') {
        btn.dataset.confirm = 'true';
        btn.textContent = 'Tap again to confirm';
        btn.className = 'px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-red-600 active:bg-red-700 text-white touch-active min-h-[48px]';
        return;
      }

      try {
        await ideasRef.doc(ideaId).delete();
        closeIdeaModal();
        showToast('Idea deleted');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    function startEditIdea() {
      state.isEditingIdea = true;
      renderIdeaModal();
    }

    function cancelEditIdea() {
      state.isEditingIdea = false;
      renderIdeaModal();
    }

    async function saveEditIdea(ideaId) {
      const title = document.getElementById('edit-title').value.trim();
      const description = document.getElementById('edit-description').value.trim();

      if (!title) {
        showToast('Title is required');
        return;
      }

      try {
        await ideasRef.doc(ideaId).update({
          title: title,
          description: description,
          updatedAt: Date.now()
        });
        state.isEditingIdea = false;
        showToast('Idea updated');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addCategory(label, color) {
      try {
        await categoriesRef.add({ label, color });
        showToast('Category added');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    function navigateStage(direction) {
      const currentIndex = STAGES.findIndex(s => s.id === state.activeStage);
      const newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < STAGES.length) {
        state.activeStage = STAGES[newIndex].id;
        render();
      }
    }

    // ==================== UTILITIES ====================
    function generateId() {
      return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== TOUCH/SWIPE HANDLING ====================
    let touchStartX = null;
    let touchStartY = null;
    let touchStartTime = null;

    document.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchend', e => {
      if (touchStartX === null || state.view !== 'pipeline') return;

      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;
      const timeDiff = Date.now() - touchStartTime;

      // Only trigger swipe if:
      // - Horizontal movement > 80px
      // - Horizontal movement > vertical movement (not scrolling)
      // - Swipe completed in under 500ms
      // - Not in a modal
      if (Math.abs(diffX) > 80 && Math.abs(diffX) > Math.abs(diffY) * 1.5 && timeDiff < 500) {
        const modal = document.querySelector('.modal-backdrop:not(.hidden)');
        if (!modal) {
          navigateStage(diffX > 0 ? 1 : -1);
        }
      }

      touchStartX = null;
      touchStartY = null;
      touchStartTime = null;
    }, { passive: true });

    // ==================== KEYBOARD HANDLING ====================
    document.addEventListener('keydown', e => {
      // Close modals on Escape
      if (e.key === 'Escape') {
        const submitModal = document.getElementById('submit-modal');
        const adminModal = document.getElementById('admin-modal');
        const ideaModal = document.getElementById('idea-modal');

        if (!submitModal.classList.contains('hidden')) closeSubmitModal();
        else if (!adminModal.classList.contains('hidden')) closeAdminModal();
        else if (!ideaModal.classList.contains('hidden')) closeIdeaModal();
      }

      // Navigate stages with arrow keys (when no modal open)
      if (state.view === 'pipeline' && !document.querySelector('.modal-backdrop:not(.hidden)')) {
        if (e.key === 'ArrowLeft') navigateStage(-1);
        else if (e.key === 'ArrowRight') navigateStage(1);
      }
    });

    // ==================== OFFLINE HANDLING ====================
    function updateOfflineStatus() {
      state.isOffline = !navigator.onLine;
      const banner = document.getElementById('offline-banner');
      if (state.isOffline) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
        // Firebase syncs automatically when back online
      }
    }

    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => {
          console.log('Service Worker registered:', reg.scope);
          // Check for updates
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showToast('Update available! Refresh to update.');
              }
            });
          });
        })
        .catch(err => console.log('SW registration failed:', err));
    }

    // Initialize
    init();
    updateOfflineStatus();
  </script>
</body>
</html>
